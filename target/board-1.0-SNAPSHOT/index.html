<!DOCTYPE html>
<html lang="en" ng-app="board">
    <head>
        <title>Online Board</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="js/ui-1.11.2/jquery-ui.min.css">
        <link rel="stylesheet" href="css/board.css">
        <script src="js/jquery-2.1.1.min.js"></script>
        <script src="js/ui-1.11.2/jquery-ui.min.js"></script>
        <script src="js/angular.min.js"></script>
        <script src="js/angular-route.min.js"></script>
    </head>
    <body>
        <div class="fullHeight" ng-view></div>

        <script>
                    var module = angular.module("board", ['ngRoute']);
                    module.config(["$routeProvider",
                        function ($routeProvider) {
                            $routeProvider.
                                    when("/board/:uuid", {
                                        templateUrl: 'tpl/board.html',
                                        controller: 'boardRouteController'
                                    }).
                                    when("/", {
                                        templateUrl: 'tpl/create_board.html',
                                        controller: 'createBoardController'
                                    }).
                                    otherwise({
                                        redirectTo: '/'
                                    });
                        }
                    ]);
                    module.controller("createBoardController", function ($scope, $http, $location) {

                        $scope.createBoardForm = {};
                        $scope.createBoardForm.submitTheForm = function (item, event) {
                            var responsePromise = $http.post("boards", {}, {});
                            responsePromise.success(function (dataFromServer, status, headers, config) {
                                $location.path("/board/" + dataFromServer.uuid);
                                console.log(dataFromServer);
                            });
                            responsePromise.error(function (data, status, headers, config) {
                                alert("Submitting form failed!");
                            });
                        };
                    });
                    module.factory('postService', function ($http) {

                        var savePost = function () {

                        };
                    });
                    module.directive('post', function ($document, Position) {
                        return {
                            restrict: 'C',
                            link: function (scope, element, attr) {
                                if(!element.scope().post.position.isUnknown()){
                                    element.offset(element.scope().post.position);
                                }
                                
                                element.draggable({
                                    stack: '.post',
                                    drag: function (event, ui) {
                                        var topDiff = ui.helper.offset().top + ui.helper.height() - $("#board").height();
                                        if (topDiff > 0) {
                                            $("#board").height($("#board").height() + topDiff + 10);
                                        }
                                        var leftDiff = ui.helper.offset().left + ui.helper.width() - $("#board").width();
                                        if (leftDiff > 0) {
                                            $("#board").width($("#board").width() + leftDiff + 10);
                                        }

                                        scope.$apply(function () {
                                            ui.helper.scope().post.position = Position.buildFromOffset(ui.helper.offset());
                                        });
                                    }
                                });
                            }
                        };
                    });
                    module.directive('postTarget', function ($document) {
                        return {
                            restrict: 'C',
                            link: function (scope, element, attr) {
                                var isGreedy = element.hasClass('local');
                                element.droppable({
                                    greedy: isGreedy,
                                    accept: ".post",
                                    drop: function (event, ui) {
                                        if ($(this).hasClass('remote')) {
                                            target = scope.remotePosts;
                                            source = scope.localPosts;
                                        } else {
                                            target = scope.localPosts;
                                            source = scope.remotePosts;
                                        }

                                        var post = ui.draggable.scope().post;
                                        if ($.inArray(post, target) > -1) {
                                            return;
                                        }

                                        scope.$apply(function () {
                                            if ($.inArray(post, source) > -1) {
                                                source.splice($.inArray(post, source), 1);
                                            }
                                            target.push(post);
                                        });
                                        /*if (!ui.draggable.parent().is("#" + $(this).attr('id'))) {
                                         var newParentPosition = $(this).offset();
                                         var newTop = ui.offset.top - newParentPosition.top;
                                         var newLeft = ui.offset.left - newParentPosition.left;
                                         console.log(ui.draggable.offset());
                                         oldPosition = ui.draggable.offset()
                                         $(ui.draggable).appendTo($(this));
                                         ui.draggable.offset(oldPosition);
                                         console.log(ui.draggable.offset());
                                         //ui.draggable.css({position: "absolute", top: newTop, left: newLeft});
                                         }*/
                                    }
                                });
                            }
                        };
                    });
                    module.factory('Post', function (Position) {

                        function Post(id, position, content) {
                            this.ids = id;
                            this.position = new Position(null, null);
                            this.content = content;
                        }

                        Post.build = function (data) {
                            return new Post(
                                    data.id,
                                    Position.build(data.position),
                                    data.content
                                    );
                        };
                        return Post;
                    });
                    module.factory('Position', function () {

                        function Position(top, left) {
                            this.top = top;
                            this.left = left;
                        }
                        
                        Position.prototype.isUnknown = function(){
                            return (this.left === null) || (this.top === null)
                        }

                        Position.build = function (data) {
                            return new Position(
                                    data.x,
                                    data.y
                                    );
                        };
                        
                        Position.buildFromOffset = function(offset){
                            return new Position(
                                    offset.top,
                                    offset.left
                                    );
                        }
                        
                        return Position;
                    });
                    module.controller("boardRouteController", function ($scope, $routeParams, Post) {
                        $scope.uuid = $routeParams.uuid;
                        $scope.localPosts = [];
                        $scope.remotePosts = [];
                        $scope.toggleSidebar = function () {
                            var sidebar = $("#sidebar");
                            if (sidebar.hasClass("collapsed")) {
                                sidebar.animate({left: '0px'}, {queue: false, duration: 500});
                                sidebar.removeClass("collapsed");
                            } else {
                                leftTarget = -sidebar.width() + 20;
                                sidebar.animate({left: leftTarget}, {queue: false, duration: 500});
                                sidebar.addClass("collapsed");
                            }
                        };
                        $scope.createLocalPost = function () {
                            $scope.localPosts.push(new Post());
                        };
                        $scope.foregroundPost = function ($event) {
                            var target = $($event.target);
                            var zmax = 0;
                            target.siblings('.post').each(function () {
                                var cur = $(this).css('z-index');
                                zmax = cur > zmax ? $(this).css('z-index') : zmax;
                            });
                            target.css('z-index', Number(zmax) + 1);
                        };
                    });</script>
    </body>
</html>

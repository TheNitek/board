<!DOCTYPE html>
<html lang="en" ng-app="board">
    <head>
        <title>Online Board</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="js/ui-1.11.2/jquery-ui.min.css">
        <link rel="stylesheet" href="css/board.css">
        <script src="js/jquery-2.1.1.min.js"></script>
        <script src="js/ui-1.11.2/jquery-ui.min.js"></script>
        <script src="js/angular.min.js"></script>
        <script src="js/angular-route.min.js"></script>
        <script src="js/angular-resource.min.js"></script>
    </head>
    <body>
        <div class="fullHeight" ng-view></div>

        <script>
                    var module = angular.module("board", ['ngRoute', 'ngResource']);
                    module.config(["$routeProvider",
                        function ($routeProvider) {
                            $routeProvider.
                                    when("/board/:uuid", {
                                        templateUrl: 'tpl/board.html',
                                        controller: 'BoardRouteController',
                                        resolve: {
                                            currentBoard: function ($route, Board) {
                                                return Board.get({uuid: $route.current.params.uuid}).$promise;
                                            }
                                        }
                                    }).
                                    when("/", {
                                        templateUrl: 'tpl/create_board.html',
                                        controller: 'CreateBoardController'
                                    }).
                                    otherwise({
                                        redirectTo: '/'
                                    });
                        }
                    ]);
                    module.controller("CreateBoardController", function ($scope, $http, $location) {

                        $scope.createBoardForm = {};
                        $scope.createBoardForm.submitTheForm = function (item, event) {
                            $http.post("boards", {})
                                    .success(function (dataFromServer, status, headers, config) {
                                        $location.path("/board/" + dataFromServer.uuid);
                                    })
                                    .error(function (data, status, headers, config) {
                                        alert("Submitting form failed!");
                                    });
                        };
                    });
                    module.directive('post', function ($document, Position) {
                        return {
                            restrict: 'C',
                            link: function ($scope, element, attr) {
                                if (!element.scope().post.position.isUnknown()) {
                                    $(element).offset(element.scope().post.position.asOffset());
                                }

                                element.draggable({
                                    stack: '.post',
                                    drag: function (event, ui) {
                                        // Expand board when post is dragged out of its current bounds
                                        var topDiff = ui.helper.offset().top + ui.helper.height() - $("#board").height();
                                        if (topDiff > 0) {
                                            $("#board").height($("#board").height() + topDiff + 10);
                                        }
                                        var leftDiff = ui.helper.offset().left + ui.helper.width() - $("#board").width();
                                        if (leftDiff > 0) {
                                            $("#board").width($("#board").width() + leftDiff + 10);
                                        }

                                        $scope.$apply(function () {
                                            ui.helper.scope().post.position = Position.buildFromOffset(ui.helper.offset());
                                            ui.helper.scope().post.position.z = ui.helper.zIndex();

                                        });
                                    }
                                });
                            }
                        };
                    });
                    module.directive('postTarget', function ($document) {
                        return {
                            restrict: 'C',
                            link: function ($scope, element, attr) {
                                var isGreedy = element.hasClass('local');
                                element.droppable({
                                    greedy: isGreedy,
                                    accept: ".post",
                                    drop: function (event, ui) {
                                        if ($(this).hasClass('remote')) {
                                            target = $scope.remotePosts;
                                            source = $scope.localPosts;
                                        } else {
                                            target = $scope.localPosts;
                                            source = $scope.remotePosts;
                                        }

                                        var post = ui.draggable.scope().post;
                                        
                                        var zmax = 0;
                                        $.each(target, function (index, value) {
                                            var cur = value.position.z;
                                            zmax = cur > zmax ? value.position.z : zmax;
                                        });

                                        $scope.$apply(function () {
                                            post.position.z = Number(zmax) + 1;
                                        });

                                        if ($.inArray(post, target) > -1) {
                                            post.$save();
                                            return;
                                        }

                                        $scope.$apply(function () {
                                            if ($.inArray(post, source) > -1) {
                                                source.splice($.inArray(post, source), 1);
                                            }
                                            target.push(post);
                                        });
                                    }
                                });
                            }
                        };
                    });
                    module.factory('Position', function () {

                        function Position(top, left, zIndex) {
                            this.y = top;
                            this.x = left;
                            this.z = zIndex;
                        }

                        Position.prototype.isUnknown = function () {
                            return (this.x === null) || (this.y === null) || (this.z === null);
                        };

                        Position.prototype.asOffset = function () {
                            return {
                                top: this.y,
                                left: this.x
                            };
                        };


                        Position.build = function (data) {
                            return new Position(
                                    data.y,
                                    data.x,
                                    data.z
                                    );
                        };

                        Position.buildFromOffset = function (offset) {
                            return new Position(
                                    offset.top,
                                    offset.left,
                                    0
                                    );
                        };

                        return Position;
                    });
                    module.factory('Board', ['$resource', 'Post', function ($resource, Post) {

                            var Board = $resource(
                                    'boards/:uuid',
                                    {
                                    },
                                    {
                                        get: {
                                            method: 'GET',
                                            isArray: false,
                                            transformResponse: function(data, header) {
                                                var board = angular.fromJson(data);
                                                var enhancedPosts = [];
                                                if(undefined !== board.posts){
                                                    for (var i = 0; i < board.posts.length; i++) {
                                                        enhancedPosts.push(Post.build(board.posts[i]));
                                                    }
                                                }
                                                board.posts = enhancedPosts;
                                                return board;
                                            }
                                        }
                                    });

                            return Board;

                        }]);
                    module.factory('Post', ['$resource', 'Position', function ($resource, Position) {

                            var Post = $resource(
                                    'boards/:boardId/posts/:postId',
                                    {
                                        boardId: '6eb2006c-5d8f-45dd-ba8c-778523305497',
                                        postId: '@id'
                                    },
                            {
                            });

                            angular.extend(Post.prototype, {
                                position: new Position(),
                                content: ''
                            });

                            Post.prototype.forground = function(){
                                
                            }
            
                            Post.build = function(data){
                                newPost = new Post(data);
                                newPost.position = Position.build(data.position);
                                return newPost;
                            }

                            return Post;
                        }]);

                    module.controller("BoardRouteController", function ($scope, Post, currentBoard) {
                        $scope.board = currentBoard;
                        $scope.localPosts = [];
                        // use board instead?
                        $scope.remotePosts = currentBoard.posts;
                        
                        $scope.$watchCollection(
                                "remotePosts",
                                function (newValue, oldValue) {
                                    if(undefined === oldValue){
                                        return;
                                    }
                                    
                                    var added = [];
                                    var removed = [];

                                    if (newValue.length > oldValue.length) {
                                        added = $(newValue).not(oldValue).get();

                                        $.each(added, function (index, value) {
                                            value.$save();
                                        });
                                    } else {
                                        removed = $(oldValue).not(newValue).get();

                                        $.each(removed, function (index, value) {
                                            value.$remove();
                                        });
                                    }
                                }
                        );

                        $scope.toggleSidebar = function () {
                            var sidebar = $("#sidebar");
                            if (sidebar.hasClass("collapsed")) {
                                sidebar.animate({left: '0px'}, {queue: false, duration: 500});
                                sidebar.removeClass("collapsed");
                            } else {
                                leftTarget = -sidebar.width() + 20;
                                sidebar.animate({left: leftTarget}, {queue: false, duration: 500});
                                sidebar.addClass("collapsed");
                            }
                        };
                        $scope.createLocalPost = function () {
                            var post = new Post();
                            post.content = 'tescht';
                            $scope.localPosts.push(post);
                        };
                        $scope.foregroundPost = function (event) {
                            var target = $(event.target);
                            var zmax = 0;
                            target.siblings('.post').each(function () {
                                var cur = $(this).zIndex();
                                zmax = cur > zmax ? $(this).zIndex() : zmax;
                            });

                            target.scope().post.position.z = Number(zmax) + 1;
                            target.scope().post.$save();
                            console.log(target.scope().post, Number(zmax) + 1);
                        };
                    });
        </script>
    </body>
</html>
